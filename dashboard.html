<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer's Connect - Enquiries & Recommendations</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css" />
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --accent: #f72585;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #e63946;
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.08);
      --shadow-hover: rgba(0, 0, 0, 0.12);
      --dark-bg-primary: #0f172a;
      --dark-bg-secondary: #1e293b;
      --dark-bg-card: #1e293b;
      --dark-text-primary: #f1f5f9;
      --dark-text-secondary: #cbd5e1;
      --dark-text-muted: #94a3b8;
      --dark-border: #334155;
      --dark-shadow: rgba(0, 0, 0, 0.3);
      --dark-shadow-hover: rgba(0, 0, 0, 0.4);
      --spacing-xs: 0.5rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.25rem;
      --font-size-xl: 1.5rem;
      --font-size-2xl: 2rem;
      --transition: all 0.2s ease;
    }

    [data-theme="dark"] {
      --bg-primary: var(--dark-bg-primary);
      --bg-secondary: var(--dark-bg-secondary);
      --bg-card: var(--dark-bg-card);
      --text-primary: var(--dark-text-primary);
      --text-secondary: var(--dark-text-secondary);
      --text-muted: var(--dark-text-muted);
      --border: var(--dark-border);
      --shadow: var(--dark-shadow);
      --shadow-hover: var(--dark-shadow-hover);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: var(--transition);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-sm) var(--spacing-lg);
      background-color: var(--bg-secondary);
      box-shadow: 0 2px 10px var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .welcome {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-weight: 600;
      font-size: var(--font-size-lg);
    }

    .dashboard-logo-inline {
      width: 24px;
      height: 24px;
      fill: var(--primary);
    }

    #userFullname {
      color: var(--primary);
      font-weight: 700;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .dark-toggle, .tour-btn, .logout-btn, .profile-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: var(--font-size-base);
      color: var(--text-primary);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      text-decoration: none;
    }

    .dark-toggle:hover, .tour-btn:hover, .logout-btn:hover, .profile-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-hover);
    }

    /* Sticky Navigation */
    .sticky-nav {
      position: sticky;
      top: 80px;
      z-index: 999;
      background: var(--bg-primary);
      padding: var(--spacing-sm) 0;
      margin-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border);
    }

    .sticky-nav-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
    }

    /* Updated View Toggle - Dropdown Style */
    .view-toggle-container {
      position: relative;
      display: inline-block;
    }

    .view-toggle-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .view-toggle-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .view-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px var(--shadow);
      padding: 0.5rem;
      z-index: 1000;
      display: none;
      margin-top: 0.25rem;
      min-width: 200px;
    }

    .view-dropdown.open {
      display: block;
    }

    .view-dropdown button {
      display: block;
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      transition: var(--transition);
      font-weight: 500;
    }

    .view-dropdown button:hover {
      background: var(--bg-primary);
    }

    .view-dropdown button.active {
      background: var(--primary);
      color: white;
    }

    .category-filter {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .category-filter select {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: var(--font-size-base);
    }

    .search-bar {
      display: flex;
      max-width: 500px;
      margin: 0;
      box-shadow: 0 2px 8px var(--shadow);
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--border);
      flex: 1;
      max-width: 300px;
    }

    #searchInput {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: var(--font-size-base);
    }

    #searchInput::placeholder {
      color: var(--text-muted);
    }

    #searchBtn {
      padding: 0.75rem 1.25rem;
      background: var(--primary);
      border: none;
      color: white;
      cursor: pointer;
      transition: var(--transition);
    }

    #searchBtn:hover {
      background: var(--primary-dark);
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-md) var(--spacing-xl);
    }

    .dashboard-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--spacing-lg);
      align-items: start;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .deals-sidebar {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--border);
      position: sticky;
      top: 140px;
    }

    .deals-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .deals-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--primary);
    }

    .new-deal-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .new-deal-btn:hover {
      background: #3ab0d9;
      transform: translateY(-2px);
    }

    .deals-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      max-height: 600px;
      overflow-y: auto;
    }

    .deal-item {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm);
      border: 1px solid var(--border);
      transition: var(--transition);
      position: relative;
    }

    .deal-item:hover {
      box-shadow: 0 2px 8px var(--shadow);
    }

    .deal-item.verified {
      border-left: 3px solid var(--success);
    }

    .deal-category {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .deal-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
      margin-right: 80px; /* Space for category tag */
    }

    .deal-product {
      font-weight: 600;
      color: var(--text-primary);
    }

    .deal-price {
      font-weight: 700;
      color: var(--success);
      font-size: var(--font-size-lg);
    }

    .deal-store {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .deal-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    .deal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .edit-deal-btn, .delete-deal-btn {
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: var(--transition);
    }

    .edit-deal-btn {
      background: var(--warning);
      color: white;
    }

    .edit-deal-btn:hover {
      background: #e6891e;
    }

    .delete-deal-btn {
      background: var(--danger);
      color: white;
    }

    .delete-deal-btn:hover {
      background: #d32f2f;
    }

    .deal-verified {
      color: var(--success);
      font-weight: 600;
    }

    .verify-deal-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: var(--transition);
    }

    .verify-deal-btn:hover:not(:disabled) {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .verify-deal-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .post-enquiry {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: 0;
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--border);
    }

    .enquiry-type-selector {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .enquiry-type-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .enquiry-type-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .enquiry-type-btn:hover:not(.active) {
      border-color: var(--primary);
      color: var(--primary);
    }

    #enquiryInput {
      width: 100%;
      min-height: 100px;
      padding: var(--spacing-sm);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      resize: vertical;
      font-family: inherit;
      font-size: var(--font-size-base);
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      transition: var(--transition);
    }

    #enquiryInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      text-align: center;
      cursor: pointer;
      margin-bottom: var(--spacing-sm);
      transition: var(--transition);
      background: var(--bg-primary);
    }

    .file-upload-area:hover, .file-upload-area.dragover {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }

    #fileUploadText {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
      display: none;
      box-shadow: 0 2px 8px var(--shadow);
    }

    #postEnquiryBtn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
    }

    #postEnquiryBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .enquiry-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .enquiry-item {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: 0 2px 8px var(--shadow);
      border: 1px solid var(--border);
      transition: var(--transition);
      position: relative;
    }

    .enquiry-item:hover {
      box-shadow: 0 4px 16px var(--shadow-hover);
      transform: translateY(-2px);
    }

    .enquiry-item.thanked {
      border-left: 4px solid var(--success);
    }

    .enquiry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }

    .enquiry-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 1;
      min-width: 200px;
    }

    .enquiry-type-badge {
      font-size: var(--font-size-sm);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      white-space: nowrap;
    }

    .enquiry-header span:first-child {
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }

    .poster {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .posted-user {
      color: var(--primary);
      font-weight: 500;
    }

    .toggle-icon {
      transition: var(--transition);
      font-size: var(--font-size-lg);
      color: var(--text-muted);
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .three-dots-btn {
      background: none;
      border: none;
      font-size: var(--font-size-lg);
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.25rem;
      border-radius: 50%;
      transition: var(--transition);
    }

    .three-dots-btn:hover {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .dropdown-menu {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px var(--shadow);
      padding: 0.5rem;
      z-index: 10;
      display: none;
      margin-top: 0.25rem;
      right: 0;
    }

    .dropdown-menu.open {
      display: block;
    }

    .dropdown-menu button {
      display: block;
      width: 100%;
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      transition: var(--transition);
    }

    .dropdown-menu button:hover {
      background: var(--bg-primary);
    }

    .dropdown-menu button:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .enquiry-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .reply-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .reply-list.open {
      max-height: 1000px;
    }

    .reply-item {
      display: flex;
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xs);
      gap: var(--spacing-xs);
    }

    .reply-text {
      flex: 1;
      color: var(--text-primary);
    }

    .helpful-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: var(--transition);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .helpful-btn:hover {
      background: var(--bg-primary);
    }

    .helpful-btn.helpful {
      color: var(--success);
      border-color: var(--success);
      background: rgba(76, 201, 240, 0.1);
    }

    .like-btn, .dislike-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: var(--transition);
      color: var(--text-secondary);
    }

    .like-btn:hover, .dislike-btn:hover {
      background: var(--bg-primary);
    }

    .like-btn.liked {
      color: var(--accent);
      border-color: var(--accent);
    }

    .dislike-btn.disliked {
      color: var(--warning);
      border-color: var(--warning);
    }

    .reply-form {
      display: flex;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-sm);
    }

    .reply-form input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .map-pin-btn, .reply-form button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .map-pin-btn {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .map-pin-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .reply-form button {
      background: var(--primary);
      color: white;
    }

    .reply-form button:hover {
      background: var(--primary-dark);
    }

    .map-container {
      height: 0;
      transition: height 0.3s ease;
      margin-top: var(--spacing-sm);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .map-container.open {
      height: 200px;
    }

    /* Updated: Smaller, more mature buttons */
    .enquiry-header button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      font-size: 0.85rem;
    }

    .thanks-btn {
      background: var(--success);
      color: white;
    }

    .thanks-btn:hover {
      background: #3ab0d9;
    }

    .delete-enquiry-btn {
      background: var(--danger);
      color: white;
      margin-left: 0.5rem;
    }

    .delete-enquiry-btn:hover {
      background: #d32f2f;
    }

    .thanked .reply-form {
      opacity: 0.6;
      pointer-events: none;
    }

    .thanked .reply-form::before {
      content: "This enquiry has been resolved - no further replies allowed";
      display: block;
      width: 100%;
      text-align: center;
      padding: var(--spacing-sm);
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: var(--spacing-sm);
    }

    .loading-message, .error-message {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      margin: var(--spacing-lg) auto;
      max-width: 500px;
      box-shadow: 0 2px 8px var(--shadow);
      gap: var(--spacing-sm);
    }

    .error-message button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      cursor: pointer;
      margin-left: var(--spacing-sm);
    }

    /* Fixed Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: var(--bg-card);
      margin: 5% auto;
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px var(--shadow);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border);
      padding-bottom: var(--spacing-sm);
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: var(--font-size-base);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .submit-deal-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: var(--spacing-sm);
    }

    .submit-deal-btn:hover {
      background: #3ab0d9;
      transform: translateY(-2px);
    }

    /* Leaderboard Styles */
    .leaderboard-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--border);
      display: none;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .leaderboard-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--primary);
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .leaderboard-rank {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: 700;
      margin-right: var(--spacing-sm);
      flex-shrink: 0;
    }

    .rank-1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #CD7F32, #A66A2A);
      color: #000;
    }

    .rank-other {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .leaderboard-user {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: var(--spacing-sm);
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-name:hover {
      color: var(--primary);
    }

    .user-points {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
      margin-top: 2px;
    }

    .badge-icon {
      width: 16px;
      height: 16px;
    }

    /* Reputation indicator styles */
    .reputation-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 6px;
      font-size: var(--font-size-sm);
      vertical-align: middle;
    }

    .points-badge {
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.7rem;
    }

    .level-badge {
      background: var(--success);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.7rem;
    }

    /* Profile link styles */
    .user-profile-link {
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: inherit;
    }

    .user-profile-link:hover {
      color: var(--primary);
    }

    /* Custom Intro.js styling */
    .introjs-tooltip {
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px var(--shadow);
    }

    .introjs-tooltip-header {
      background: var(--primary);
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .introjs-button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      margin: 0 0.25rem;
      transition: var(--transition);
    }

    .introjs-button:hover {
      background: var(--primary-dark);
    }

    .introjs-skipbutton {
      background: var(--text-muted);
    }

    .introjs-skipbutton:hover {
      background: var(--danger);
    }

    .introjs-bullets ul li a {
      background: var(--border);
    }

    .introjs-bullets ul li a.active {
      background: var(--primary);
    }

    .introjs-arrow {
      border-color: var(--bg-card);
    }

    @media (max-width: 968px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      
      .deals-sidebar {
        position: static;
        order: -1;
      }
      
      .sticky-nav-content {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-sm);
      }
      
      .search-bar {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      header {
        flex-wrap: wrap;
        gap: var(--spacing-sm);
      }
      
      .header-controls {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: var(--spacing-sm);
      }
      
      .enquiry-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .reply-form {
        flex-direction: column;
      }
      
      .enquiry-type-selector {
        flex-direction: column;
      }
      
      .deals-header {
        flex-direction: column;
        gap: var(--spacing-sm);
        align-items: flex-start;
      }
      
      .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: var(--spacing-md);
      }
      
      .sticky-nav {
        top: 120px;
      }

      .view-toggle-container {
        width: 100%;
      }

      .view-toggle-btn {
        width: 100%;
        justify-content: space-between;
      }

      .view-dropdown {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="welcome">
      <svg class="dashboard-logo-inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M20.5 3l-5.5 2-5-2-6 2v16l6-2 5 2 5.5-2v-16zM12 17a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
      </svg>
      Welcome, <span id="userFullname">User</span>
    </div>
    <div class="header-controls">
      <button class="dark-toggle" id="darkToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
      <a href="profile.html" class="profile-btn" id="profileBtn" aria-label="My Profile">My Profile</a>
      <button class="tour-btn" id="startTourBtn" aria-label="Start guided tour">
        <span style="font-size:1.3em; vertical-align:middle;">&#128161;</span> Tour
      </button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </header>
  
  <!-- Sticky Navigation -->
  <div class="sticky-nav">
    <div class="sticky-nav-content">
      <!-- Updated: Dropdown menu for navigation -->
      <div class="view-toggle-container">
        <button class="view-toggle-btn" id="viewToggleBtn">
          <span id="currentViewText">All Enquiries</span>
          <span style="font-size:0.8em;">‚ñº</span>
        </button>
        <div class="view-dropdown" id="viewDropdown">
          <button data-view="all" class="active">All Enquiries</button>
          <button data-view="mine">My Enquiries</button>
          <button data-view="leaderboard">üèÜ Leaderboard</button>
          <button data-view="deals">Deals</button>
        </div>
      </div>
      
      <div class="category-filter" id="categoryFilter" style="display: none;">
        <label for="dealCategoryFilter">Filter by:</label>
        <select id="dealCategoryFilter">
          <option value="all">All Categories</option>
          <option value="technology">Technology</option>
          <option value="food">Food & Dining</option>
          <option value="fashion">Fashion</option>
          <option value="home">Home & Garden</option>
          <option value="health">Health & Beauty</option>
          <option value="entertainment">Entertainment</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="search-bar" role="search">
        <input type="search" id="searchInput" aria-label="Search enquiries" placeholder="Search..." />
        <button id="searchBtn" aria-label="Search">üîç</button>
      </div>
    </div>
  </div>
  
  <div id="loading" class="loading-message" style="display:none;">
    <span>‚è≥</span> Loading...
  </div>
  
  <div id="error" class="error-message" style="display:none;">
    <span>‚ö†Ô∏è</span> Could not load content. <button id="retryBtn">Retry</button>
  </div>

  <main>
    <!-- Leaderboard Section -->
    <section class="leaderboard-section" id="leaderboardSection">
      <div class="leaderboard-header">
        <h3 class="leaderboard-title">üèÜ Community Leaderboard</h3>
        <div class="user-points">Your Points: <span id="userPoints">0</span></div>
      </div>
      <div class="leaderboard-list" id="leaderboardList">
        <!-- Leaderboard will be populated here -->
      </div>
    </section>

    <div class="dashboard-layout">
      <div class="main-content">
        <section class="post-enquiry" aria-label="Post a new enquiry" id="postEnquirySection">
          <div class="enquiry-type-selector">
            <button class="enquiry-type-btn active" data-type="GENERAL">‚ùì General</button>
            <button class="enquiry-type-btn" data-type="PRICE_CHECK">üí∞ Price Check</button>
            <button class="enquiry-type-btn" data-type="AVAILABILITY">üì¶ Availability</button>
            <button class="enquiry-type-btn" data-type="RECOMMENDATION">‚≠ê Recommendation</button>
            <button class="enquiry-type-btn" data-type="AUTHENTICITY">üîç Authenticity</button>
          </div>
          <textarea id="enquiryInput" placeholder="Ask where to find the best quality product..." aria-label="Enquiry text"></textarea>
          <div class="file-upload-area" id="fileUploadArea" tabindex="0" role="button" aria-describedby="fileUploadText">
            <span id="fileUploadText">+ Add or Drag Product Image</span>
            <input type="file" id="imageUpload" accept="image/*" style="display:none" />
          </div>
          <img id="imagePreview" class="image-preview" alt="Product preview" />
          <button id="postEnquiryBtn">Post Enquiry</button>
        </section>

        <section class="enquiry-list" id="enquiryList" aria-live="polite" aria-label="List of enquiries and replies">
          <!-- Enquiries will be rendered here -->
        </section>
      </div>

      <aside class="deals-sidebar" id="dealsSidebar">
        <div class="deals-header">
          <h3 class="deals-title">üî• Hot Deals</h3>
          <button class="new-deal-btn" id="newDealBtn">+ Share Deal</button>
        </div>
        <div class="deals-list" id="dealsList">
          <!-- Deals will be rendered here -->
        </div>
      </aside>
    </div>
  </main>

  <!-- Deal Modal -->
  <div id="dealModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="dealModalTitle">Share a Great Deal</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="dealForm">
        <input type="hidden" id="dealId" value="">
        <div class="form-group">
          <label for="dealProduct">Product Name *</label>
          <input type="text" id="dealProduct" required>
        </div>
        <div class="form-group">
          <label for="dealCategory">Category *</label>
          <select id="dealCategory" required>
            <option value="">Select a category</option>
            <option value="technology">Technology</option>
            <option value="food">Food & Dining</option>
            <option value="fashion">Fashion</option>
            <option value="home">Home & Garden</option>
            <option value="health">Health & Beauty</option>
            <option value="entertainment">Entertainment</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dealStore">Store *</label>
          <input type="text" id="dealStore" required>
        </div>
        <div class="form-group">
          <label for="dealPrice">Current Price *</label>
          <input type="number" id="dealPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="dealOriginalPrice">Original Price (optional)</label>
          <input type="number" id="dealOriginalPrice" step="0.01">
        </div>
        <div class="form-group">
          <label for="dealLocation">Location</label>
          <input type="text" id="dealLocation" placeholder="City or store location">
        </div>
        <div class="form-group">
          <label for="dealDescription">Description</label>
          <textarea id="dealDescription" placeholder="Any details about the deal..."></textarea>
        </div>
        <button type="submit" class="submit-deal-btn" id="dealSubmitBtn">Share Deal</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <script>
    // Socket.IO connection
    const socket = io('http://localhost:5000');
    
    // Global state
    let enquiries = [];
    let deals = [];
    let currentView = 'all';
    let newEnquiryImageFile = null;
    let lastSearch = '';
    let selectedEnquiryType = 'GENERAL';
    let selectedDealCategory = 'all';
    const reportedEnquiries = new Set();
    
    // Leaderboard data
    let leaderboardData = [];
    let userPoints = 0;
    let userLevel = 1;
    
    // Badge definitions
    const badges = {
      'helper': { name: 'Helper', icon: 'ü§ù', minPoints: 50 },
      'expert': { name: 'Expert', icon: '‚≠ê', minPoints: 150 },
      'guru': { name: 'Guru', icon: 'üß†', minPoints: 300 },
      'champion': { name: 'Champion', icon: 'üèÜ', minPoints: 500 }
    };
    
    // Deal categories
    const dealCategories = {
      'technology': 'Technology',
      'food': 'Food & Dining',
      'fashion': 'Fashion',
      'home': 'Home & Garden',
      'health': 'Health & Beauty',
      'entertainment': 'Entertainment',
      'other': 'Other'
    };
    
    // DOM Elements
    const userFullname = localStorage.getItem('fullname') || 'User';
    const userEmail = localStorage.getItem('email') || '';
    document.getElementById('userFullname').textContent = userFullname;
    
    const darkToggle = document.getElementById('darkToggle');
    const logoutBtn = document.getElementById('logoutBtn');
    const enquiryListEl = document.getElementById('enquiryList');
    const enquiryInputEl = document.getElementById('enquiryInput');
    const postEnquiryBtn = document.getElementById('postEnquiryBtn');
    const imageUploadInput = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileUploadText = document.getElementById('fileUploadText');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const retryBtn = document.getElementById('retryBtn');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const newDealBtn = document.getElementById('newDealBtn');
    const dealModal = document.getElementById('dealModal');
    const closeModal = document.querySelector('.close-modal');
    const dealForm = document.getElementById('dealForm');
    const dealsList = document.getElementById('dealsList');
    const enquiryTypeBtns = document.querySelectorAll('.enquiry-type-btn');
    const categoryFilter = document.getElementById('categoryFilter');
    const dealCategoryFilter = document.getElementById('dealCategoryFilter');
    const dealModalTitle = document.getElementById('dealModalTitle');
    const dealSubmitBtn = document.getElementById('dealSubmitBtn');
    const dealIdInput = document.getElementById('dealId');
    
    // Leaderboard elements
    const leaderboardSection = document.getElementById('leaderboardSection');
    const leaderboardList = document.getElementById('leaderboardList');
    const userPointsEl = document.getElementById('userPoints');
    
    // Updated: Dropdown navigation elements
    const viewToggleBtn = document.getElementById('viewToggleBtn');
    const viewDropdown = document.getElementById('viewDropdown');
    const currentViewText = document.getElementById('currentViewText');
    const viewDropdownButtons = document.querySelectorAll('.view-dropdown button');

    // Socket event handlers
    socket.on('connect', () => {
      console.log('Socket.IO connected! Socket ID:', socket.id);
    });

    socket.on('newEnquiry', (enquiry) => {
      const index = enquiries.findIndex(e => e.id === enquiry.id);
      if (index >= 0) {
        enquiries[index] = enquiry;
      } else {
        enquiries.push(enquiry);
      }
      renderEnquiries();
    });

    socket.on('newReply', ({ enquiryId, reply }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        enquiry.replies = enquiry.replies || [];
        enquiry.replies.push(reply);
        renderEnquiries();
      }
    });

    socket.on('replyLiked', ({ enquiryId, replyId, likes, likedBy }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        const reply = enquiry.replies.find(r => r.replyId === replyId);
        if (reply) {
          reply.likes = likes;
          reply.likedBy = likedBy;
          renderEnquiries();
        }
      }
    });

    socket.on('replyDisliked', ({ enquiryId, replyId, dislikes, dislikedBy }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        const reply = enquiry.replies.find(r => r.replyId === replyId);
        if (reply) {
          reply.dislikes = dislikes;
          reply.dislikedBy = dislikedBy;
          renderEnquiries();
        }
      }
    });

    socket.on('enquiryDeleted', ({ enquiryId }) => {
      enquiries = enquiries.filter(e => e.id !== enquiryId);
      renderEnquiries();
    });

    socket.on('enquiryThanked', ({ enquiryId, thanked }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        enquiry.thanked = thanked;
        renderEnquiries();
      }
    });

    socket.on('newDeal', (deal) => {
      fetchDeals();
    });

    socket.on('dealUpdated', (deal) => {
      fetchDeals();
    });

    socket.on('dealDeleted', ({ dealId }) => {
      deals = deals.filter(d => d.id !== dealId);
      renderDeals();
    });

    socket.on('dealVerified', ({ dealId, verificationCount, verified }) => {
      const dealItem = document.querySelector(`.deal-item[data-deal-id="${dealId}"]`);
      if (dealItem) {
        const verifyCount = dealItem.querySelector('.deal-verify-count');
        const verifyBtn = dealItem.querySelector('.verify-deal-btn');
        if (verifyCount) verifyCount.textContent = verificationCount;
        if (verified) {
          dealItem.classList.add('verified');
          if (verifyBtn) verifyBtn.disabled = true;
        }
      }
    });

    socket.on('replyHelpfulUpdated', ({ enquiryId, replyId, helpfulCount }) => {
      const replyEl = document.querySelector(`.reply-item[data-reply-id="${replyId}"]`);
      if (replyEl) {
        const helpfulSpan = replyEl.querySelector('.helpful-count');
        if (helpfulSpan) helpfulSpan.textContent = helpfulCount;
      }
    });

    // Event Listeners
    darkToggle.onclick = () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
      darkToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('fullname');
      alert('Logged out');
      window.location.href = 'index.html';
    };

    // Enquiry type selection
    enquiryTypeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        enquiryTypeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedEnquiryType = btn.dataset.type;
      });
    });

    // Updated: Dropdown navigation functionality
    viewToggleBtn.addEventListener('click', () => {
      viewDropdown.classList.toggle('open');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!viewToggleBtn.contains(e.target) && !viewDropdown.contains(e.target)) {
        viewDropdown.classList.remove('open');
      }
    });

    // View toggle handlers
    viewDropdownButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.getAttribute('data-view');
        switchView(view);
        viewDropdown.classList.remove('open');
        
        // Update active state
        viewDropdownButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update button text
        currentViewText.textContent = btn.textContent;
      });
    });

    function switchView(view) {
      currentView = view;
      
      // Hide all sections first
      document.getElementById('postEnquirySection').style.display = 'none';
      document.getElementById('enquiryList').style.display = 'none';
      document.getElementById('dealsSidebar').style.display = 'none';
      leaderboardSection.style.display = 'none';
      categoryFilter.style.display = 'none';
      
      if (view === 'deals') {
        document.getElementById('dealsSidebar').style.display = 'block';
        categoryFilter.style.display = 'flex';
        fetchDeals();
      } else if (view === 'leaderboard') {
        leaderboardSection.style.display = 'block';
        fetchLeaderboard();
      } else {
        document.getElementById('postEnquirySection').style.display = 'block';
        document.getElementById('enquiryList').style.display = 'block';
        document.getElementById('dealsSidebar').style.display = 'block';
        fetchEnquiries();
      }
    }

    // Deal category filter
    dealCategoryFilter.addEventListener('change', (e) => {
      selectedDealCategory = e.target.value;
      renderDeals();
    });

    // File upload handling
    fileUploadArea.addEventListener('click', () => imageUploadInput.click());
    fileUploadArea.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        imageUploadInput.click();
      }
    });
    fileUploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });
    fileUploadArea.addEventListener('dragleave', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
    });
    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        imageUploadInput.files = e.dataTransfer.files;
        imageUploadInput.dispatchEvent(new Event('change'));
      }
    });

    imageUploadInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) {
        newEnquiryImageFile = null;
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        fileUploadText.textContent = '+ Add or Drag Product Image';
        return;
      }
      newEnquiryImageFile = file;
      const reader = new FileReader();
      reader.onload = function(event) {
        imagePreview.src = event.target.result;
        imagePreview.style.display = 'block';
        fileUploadText.textContent = 'Image selected!';
      };
      reader.readAsDataURL(file);
    });

    // Modal handlers
    newDealBtn.onclick = () => {
      dealModalTitle.textContent = 'Share a Great Deal';
      dealSubmitBtn.textContent = 'Share Deal';
      dealForm.reset();
      dealIdInput.value = '';
      dealModal.style.display = 'block';
    };
    
    closeModal.onclick = () => {
      dealModal.style.display = 'none';
    };
    
    window.onclick = (e) => {
      if (e.target === dealModal) {
        dealModal.style.display = 'none';
      }
    };

    // Deal form submission
    dealForm.onsubmit = async (e) => {
      e.preventDefault();
      
      const dealId = dealIdInput.value;
      const isEdit = !!dealId;
      
      const dealData = {
        productName: document.getElementById('dealProduct').value,
        category: document.getElementById('dealCategory').value,
        store: document.getElementById('dealStore').value,
        price: parseFloat(document.getElementById('dealPrice').value),
        originalPrice: document.getElementById('dealOriginalPrice').value ? 
          parseFloat(document.getElementById('dealOriginalPrice').value) : null,
        location: document.getElementById('dealLocation').value,
        description: document.getElementById('dealDescription').value,
        postedBy: userFullname,
        email: userEmail
      };

      try {
        const url = isEdit ? `http://localhost:5000/api/deals/${dealId}` : 'http://localhost:5000/api/deals';
        const method = isEdit ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method: method,
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dealData)
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to ${isEdit ? 'update' : 'post'} deal: ${res.status} ${errorText}`);
        }
        
        const result = await res.json();
        console.log('Deal processed successfully:', result);
        
        dealForm.reset();
        dealModal.style.display = 'none';
        fetchDeals();
        
        // Show success message
        alert(`Deal ${isEdit ? 'updated' : 'shared'} successfully!`);
      } catch (error) {
        console.error('Error processing deal:', error);
        alert(`Failed to ${isEdit ? 'update' : 'share'} deal. Please try again. Error: ` + error.message);
      }
    };

    // Fetch and render deals
    async function fetchDeals() {
      try {
        const res = await fetch('http://localhost:5000/api/deals');
        if (!res.ok) throw new Error('Failed to fetch deals');
        deals = await res.json();
        renderDeals();
      } catch (error) {
        console.error('Error fetching deals:', error);
        dealsList.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:var(--spacing-md);">Error loading deals</p>';
      }
    }

    function renderDeals() {
      dealsList.innerHTML = '';
      
      if (!deals || deals.length === 0) {
        dealsList.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:var(--spacing-md);">No deals shared yet. Be the first to share a deal!</p>';
        return;
      }

      // Filter deals by category if needed
      let filteredDeals = deals;
      if (selectedDealCategory !== 'all') {
        filteredDeals = deals.filter(deal => deal.category === selectedDealCategory);
      }

      if (filteredDeals.length === 0) {
        dealsList.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding:var(--spacing-md);">No deals in the ${dealCategories[selectedDealCategory] || selectedDealCategory} category yet.</p>`;
        return;
      }

      filteredDeals.forEach(deal => {
        const dealEl = document.createElement('div');
        dealEl.className = `deal-item ${deal.verified ? 'verified' : ''}`;
        dealEl.setAttribute('data-deal-id', deal.id);

        const discount = deal.originalPrice ? 
          Math.round((1 - deal.price / deal.originalPrice) * 100) : null;

        // Check if current user is the deal poster
        const isDealOwner = deal.email === userEmail;

        dealEl.innerHTML = `
          ${deal.category ? `<div class="deal-category">${dealCategories[deal.category] || deal.category}</div>` : ''}
          <div class="deal-header">
            <div class="deal-product">${deal.productName}</div>
            <div class="deal-price">$${deal.price.toFixed(2)}</div>
          </div>
          <div class="deal-store">at ${deal.store}</div>
          ${discount ? `<div style="color:var(--success); font-weight:600;">${discount}% OFF</div>` : ''}
          ${deal.description ? `<div style="margin-top:0.5rem; font-size:0.9rem;">${deal.description}</div>` : ''}
          ${deal.location ? `<div style="color:var(--text-muted); font-size:0.8rem;">üìç ${deal.location}</div>` : ''}
          <div class="deal-meta">
            <span>by ${deal.postedBy}</span>
            <button class="verify-deal-btn" onclick="verifyDeal(${deal.id})" 
                    ${deal.verifiers && deal.verifiers.includes(userEmail) ? 'disabled' : ''}>
              ‚úÖ <span class="deal-verify-count">${deal.verificationCount || 0}</span>
            </button>
          </div>
          ${isDealOwner ? `
            <div class="deal-actions">
              <button class="edit-deal-btn" onclick="editDeal(${deal.id})">Edit</button>
              <button class="delete-deal-btn" onclick="deleteDeal(${deal.id})">Delete</button>
            </div>
          ` : ''}
        `;

        dealsList.appendChild(dealEl);
      });
    }

    // Edit deal function
    window.editDeal = async (dealId) => {
      const deal = deals.find(d => d.id === dealId);
      if (!deal) return;
      
      // Pre-fill the form with deal data
      document.getElementById('dealProduct').value = deal.productName;
      document.getElementById('dealCategory').value = deal.category || '';
      document.getElementById('dealStore').value = deal.store;
      document.getElementById('dealPrice').value = deal.price;
      document.getElementById('dealOriginalPrice').value = deal.originalPrice || '';
      document.getElementById('dealLocation').value = deal.location || '';
      document.getElementById('dealDescription').value = deal.description || '';
      dealIdInput.value = deal.id;
      
      // Update modal title and button
      dealModalTitle.textContent = 'Edit Deal';
      dealSubmitBtn.textContent = 'Update Deal';
      
      // Show modal
      dealModal.style.display = 'block';
    };

    // Delete deal function
    window.deleteDeal = async (dealId) => {
      if (!confirm('Are you sure you want to delete this deal? This action cannot be undone.')) {
        return;
      }
      
      try {
        const res = await fetch(`http://localhost:5000/api/deals/${dealId}`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: userEmail })
        });
        
        if (!res.ok) {
          throw new Error('Failed to delete deal');
        }
        
        fetchDeals();
        alert('Deal deleted successfully!');
      } catch (error) {
        console.error('Error deleting deal:', error);
        alert('Failed to delete deal. Please try again.');
      }
    };

    // Verify deal function
    window.verifyDeal = async (dealId) => {
      try {
        const res = await fetch(`http://localhost:5000/api/deals/${dealId}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ verifierEmail: userEmail })
        });
        
        if (!res.ok) throw new Error('Failed to verify deal');
        fetchDeals();
      } catch (error) {
        alert('Failed to verify deal. Please try again.');
      }
    };

    // Fetch and render enquiries
    async function fetchEnquiries() {
      loadingEl.style.display = 'flex';
      errorEl.style.display = 'none';
      enquiryListEl.innerHTML = '';
      try {
        const res = await fetch('http://localhost:5000/enquiries');
        if (!res.ok) throw new Error('Failed to fetch enquiries');
        enquiries = await res.json();
        loadingEl.style.display = 'none';
        renderEnquiries();
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'flex';
      }
    }

    retryBtn.onclick = fetchEnquiries;

    // Fetch leaderboard data
    async function fetchLeaderboard() {
      try {
        const res = await fetch('http://localhost:5000/api/leaderboard');
        if (!res.ok) throw new Error('Failed to fetch leaderboard');
        leaderboardData = await res.json();
        renderLeaderboard();
        
        // Update user's own points
        const currentUser = leaderboardData.find(user => user.email === userEmail);
        if (currentUser) {
          userPoints = currentUser.points || 0;
          userLevel = calculateLevel(userPoints);
          userPointsEl.textContent = userPoints;
        }
      } catch (error) {
        console.error('Error fetching leaderboard:', error);
        leaderboardList.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:var(--spacing-md);">Error loading leaderboard</p>';
      }
    }

    // Calculate user level based on points
    function calculateLevel(points) {
      return Math.floor(points / 100) + 1;
    }

    // Get user's highest badge
    function getHighestBadge(points, userBadges = []) {
      let highestBadge = null;
      for (const [key, badge] of Object.entries(badges)) {
        if (points >= badge.minPoints) {
          highestBadge = badge;
        }
      }
      return highestBadge;
    }

    // Render leaderboard
    function renderLeaderboard() {
      leaderboardList.innerHTML = '';
      
      if (!leaderboardData || leaderboardData.length === 0) {
        leaderboardList.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:var(--spacing-md);">No leaderboard data available yet.</p>';
        return;
      }

      leaderboardData.forEach((user, index) => {
        const rank = index + 1;
        const userLevel = calculateLevel(user.points || 0);
        const highestBadge = getHighestBadge(user.points || 0, user.badges || []);
        
        const leaderboardItem = document.createElement('div');
        leaderboardItem.className = 'leaderboard-item';
        
        leaderboardItem.innerHTML = `
          <div class="leaderboard-rank ${rank <= 3 ? `rank-${rank}` : 'rank-other'}">
            ${rank}
          </div>
          <div class="leaderboard-user">
            <div class="user-avatar">${user.fullname ? user.fullname.charAt(0).toUpperCase() : 'U'}</div>
            <div class="user-info">
              <a href="profile.html?view=${user.email}" class="user-name">
                ${user.fullname || 'Unknown User'}
              </a>
              <div class="user-points">${user.points || 0} points ‚Ä¢ Level ${userLevel}</div>
              ${highestBadge ? `
                <div class="user-badge">
                  <span class="badge-icon">${highestBadge.icon}</span>
                  ${highestBadge.name}
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        leaderboardList.appendChild(leaderboardItem);
      });
    }

    async function handleReportClick(enquiryId, button, dropdown) {
      if (reportedEnquiries.has(enquiryId)) {
        alert('You have already reported this enquiry.');
        return;
      }
      const confirmReport = confirm('Are you sure you want to report this enquiry?');
      if (!confirmReport) return;

      try {
        const res = await fetch(`http://localhost:5000/enquiries/${enquiryId}/report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: userFullname })
        });
        if (!res.ok) {
          const err = await res.json();
          alert('Failed to report enquiry: ' + (err.error || 'Unknown error'));
          return;
        }
        reportedEnquiries.add(enquiryId);
        alert('Enquiry reported. Thank you.');
        button.disabled = true;
        dropdown.classList.remove('open');
      } catch (error) {
        alert('Error reporting enquiry. Please try again.');
      }
    }

    function renderEnquiries() {
      enquiryListEl.innerHTML = '';
      let filteredEnquiries = enquiries;
      
      if (currentView === 'mine') {
        filteredEnquiries = enquiries.filter(e => e.postedBy === userFullname);
      }
      
      if (lastSearch.trim()) {
        const q = lastSearch.trim().toLowerCase();
        filteredEnquiries = filteredEnquiries.filter(
          e => (e.question && e.question.toLowerCase().includes(q)) ||
            (e.replies && e.replies.some(r => r.text && r.text.toLowerCase().includes(q)))
        );
      }
      
      if (!filteredEnquiries || filteredEnquiries.length === 0) {
        enquiryListEl.innerHTML = `<p style="color:var(--text-muted); font-style: italic; text-align: center; padding: var(--spacing-lg);">No enquiries to display.</p>`;
        return;
      }

      filteredEnquiries.slice().reverse().forEach((enquiry) => {
        const enquiryEl = document.createElement('article');
        enquiryEl.className = 'enquiry-item';
        if (enquiry.thanked) enquiryEl.classList.add('thanked');
        enquiryEl.setAttribute('tabindex', '0');

        const headerEl = document.createElement('div');
        headerEl.className = 'enquiry-header';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'enquiry-title';
        
        // Add enquiry type badge
        if (enquiry.typeLabel) {
          const typeBadge = document.createElement('span');
          typeBadge.className = 'enquiry-type-badge';
          typeBadge.textContent = enquiry.typeLabel;
          titleDiv.appendChild(typeBadge);
        }

        const questionSpan = document.createElement('span');
        questionSpan.textContent = enquiry.question;
        titleDiv.appendChild(questionSpan);

        headerEl.appendChild(titleDiv);

        // Get user data for reputation indicator
        const userData = leaderboardData.find(user => user.fullname === enquiry.postedBy) || {};
        const userPoints = userData.points || 0;
        const userLevel = calculateLevel(userPoints);
        const highestBadge = getHighestBadge(userPoints, userData.badges || []);

        const userLabel = document.createElement('span');
        userLabel.className = 'poster';
        userLabel.innerHTML = `(posted by 
          <a href="profile.html?view=${enquiry.email || ''}" class="user-profile-link">
            <span class="posted-user">${enquiry.postedBy}</span>
            <span class="reputation-indicator">
              <span class="points-badge" title="${userPoints} points">${userPoints}</span>
              ${highestBadge ? `<span class="badge-icon" title="${highestBadge.name}">${highestBadge.icon}</span>` : ''}
            </span>
          </a>)`;
        headerEl.appendChild(userLabel);

        const toggleIcon = document.createElement('span');
        toggleIcon.className = 'toggle-icon';
        toggleIcon.innerHTML = '&#9660;';
        headerEl.appendChild(toggleIcon);

        // Three dots menu for non-posters
        if (enquiry.postedBy !== userFullname) {
          const threeDotsBtn = document.createElement('button');
          threeDotsBtn.className = 'three-dots-btn';
          threeDotsBtn.setAttribute('aria-label', 'More options');
          threeDotsBtn.innerHTML = '&#8942;';

          const dropdownMenu = document.createElement('div');
          dropdownMenu.className = 'dropdown-menu';

          const reportBtn = document.createElement('button');
          reportBtn.textContent = reportedEnquiries.has(enquiry.id) ? 'Reported' : 'Report Enquiry';
          reportBtn.disabled = reportedEnquiries.has(enquiry.id);
          reportBtn.onclick = e => {
            e.stopPropagation();
            handleReportClick(enquiry.id, reportBtn, dropdownMenu);
          };
          dropdownMenu.appendChild(reportBtn);

          threeDotsBtn.onclick = e => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
              if (menu !== dropdownMenu) menu.classList.remove('open');
            });
            dropdownMenu.classList.toggle('open');
          };

          document.addEventListener('click', () => {
            dropdownMenu.classList.remove('open');
          });

          headerEl.appendChild(threeDotsBtn);
          headerEl.appendChild(dropdownMenu);
        }

        // Updated: Smaller, more mature delete and thanks buttons for poster
        if (enquiry.postedBy === userFullname) {
          const buttonContainer = document.createElement('div');
          buttonContainer.style.display = 'flex';
          buttonContainer.style.gap = '0.5rem';
          buttonContainer.style.alignItems = 'center';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-enquiry-btn';
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = async e => {
            e.stopPropagation();
            if (!confirm('Are you sure you want to delete this enquiry?')) return;
            try {
              const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}?user=${encodeURIComponent(userFullname)}`, {
                method: 'DELETE'
              });
              if (!res.ok) {
                const err = await res.json();
                alert('Failed to delete enquiry: ' + (err.error || 'Unknown error'));
                return;
              }
              enquiries = enquiries.filter(e => e.id !== enquiry.id);
              renderEnquiries();
            } catch {
              alert('Error deleting enquiry. Please try again.');
            }
          };

          const thanksBtn = document.createElement('button');
          thanksBtn.className = 'thanks-btn';
          thanksBtn.title = 'Mark enquiry as resolved';
          thanksBtn.textContent = enquiry.thanked ? 'Resolved' : 'Mark Resolved';

          thanksBtn.onclick = async ev => {
            ev.stopPropagation();
            try {
              const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/thanks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: userFullname }),
              });
              if (!res.ok) {
                const err = await res.json();
                alert('Failed to update status: ' + (err.error || 'Unknown error'));
                return;
              }
              enquiry.thanked = !enquiry.thanked;
              thanksBtn.textContent = enquiry.thanked ? 'Resolved' : 'Mark Resolved';
              enquiryEl.classList.toggle('thanked', enquiry.thanked);
              renderEnquiries();
            } catch {
              alert('Error marking enquiry as resolved. Please try again.');
            }
          };

          buttonContainer.appendChild(thanksBtn);
          buttonContainer.appendChild(deleteBtn);
          headerEl.appendChild(buttonContainer);
        }

        enquiryEl.appendChild(headerEl);

        // Image if any
        if (enquiry.image && typeof enquiry.image === 'string' && enquiry.image.trim() !== '') {
          const imgEl = document.createElement('img');
          imgEl.className = 'enquiry-image';
          imgEl.src = `http://localhost:5000${enquiry.image}`;
          imgEl.alt = 'Product image for enquiry';
          enquiryEl.appendChild(imgEl);
        }

        // Replies container
        const repliesEl = document.createElement('div');
        repliesEl.className = 'reply-list';

        if (Array.isArray(enquiry.replies)) {
          // Sort replies by like/dislike ratio desc, tie break by likes desc
          enquiry.replies.sort((a, b) => {
            function ratio(r) {
              if ((r.dislikes || 0) === 0) return r.likes > 0 ? Infinity : 0;
              return r.likes / r.dislikes;
            }
            const ra = ratio(a);
            const rb = ratio(b);
            if (rb === ra) return (b.likes || 0) - (a.likes || 0);
            return rb - ra;
          });

          enquiry.replies.forEach(reply => {
            const replyEl = document.createElement('div');
            replyEl.className = 'reply-item';
            replyEl.setAttribute('data-reply-id', reply.replyId);

            // Get user data for reputation indicator
            const replyUserData = leaderboardData.find(user => user.fullname === reply.replyBy) || {};
            const replyUserPoints = replyUserData.points || 0;
            const replyUserLevel = calculateLevel(replyUserPoints);
            const replyHighestBadge = getHighestBadge(replyUserPoints, replyUserData.badges || []);

            const replyTextEl = document.createElement('div');
            replyTextEl.className = 'reply-text';
            replyTextEl.innerHTML = `
              <a href="profile.html?view=${reply.email || ''}" class="user-profile-link">
                <strong>${reply.replyBy}</strong>
                <span class="reputation-indicator">
                  <span class="points-badge" title="${replyUserPoints} points">${replyUserPoints}</span>
                  ${replyHighestBadge ? `<span class="badge-icon" title="${replyHighestBadge.name}">${replyHighestBadge.icon}</span>` : ''}
                </span>
              </a>: ${reply.text}
            `;
            replyEl.appendChild(replyTextEl);

            // Helpful button (new feature)
            const helpfulBtn = document.createElement('button');
            helpfulBtn.className = 'helpful-btn';
            helpfulBtn.setAttribute('aria-label', 'Mark as helpful');
            helpfulBtn.innerHTML = `üëç Helpful <span class="helpful-count">${reply.helpfulCount || 0}</span>`;
            
            if (reply.helpfulRatings && reply.helpfulRatings.some(r => r.voterEmail === localStorage.getItem('email'))) {
              helpfulBtn.classList.add('helpful');
            }

            helpfulBtn.onclick = async () => {
              try {
                const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies/${reply.replyId}/helpful`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ voterEmail: localStorage.getItem('email') })
                });
                await fetchEnquiries();
              } catch {
                alert('Failed to update helpful rating. Try again.');
              }
            };
            replyEl.appendChild(helpfulBtn);

            // Like button (keep for compatibility)
            const likeBtn = document.createElement('button');
            likeBtn.className = 'like-btn';
            likeBtn.setAttribute('aria-label', 'Like reply');
            likeBtn.innerHTML = `&#10084; <span>${reply.likes || 0}</span>`;
            if (reply.likedBy && reply.likedBy.includes(userFullname)) {
              likeBtn.classList.add('liked');
            }
            likeBtn.onclick = async () => {
              try {
                const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies/${reply.replyId}/like`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user: userFullname })
                });
                const result = await res.json();
                if (result && result.liked !== undefined) {
                  await fetchEnquiries();
                }
              } catch {
                alert('Failed to update like. Try again.');
              }
            };
            replyEl.appendChild(likeBtn);

            // Dislike button (keep for compatibility)
            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = 'dislike-btn';
            dislikeBtn.setAttribute('aria-label', 'Dislike reply');
            dislikeBtn.innerHTML = `&#128078; <span></span>`;
            if (enquiry.postedBy === userFullname) {
              dislikeBtn.querySelector('span').textContent = reply.dislikes || 0;
            } else {
              dislikeBtn.querySelector('span').textContent = '';
            }
            if (reply.dislikedBy && reply.dislikedBy.includes(userFullname)) {
              dislikeBtn.classList.add('disliked');
            }
            dislikeBtn.onclick = async () => {
              try {
                const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies/${reply.replyId}/dislike`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user: userFullname })
                });
                const result = await res.json();
                if (result && typeof result.disliked !== 'undefined') {
                  await fetchEnquiries();
                }
              } catch {
                alert('Failed to update dislike. Try again.');
              }
            };
            replyEl.appendChild(dislikeBtn);

            // View location button if mapPin present
            if (reply.mapPin) {
              const locBtn = document.createElement('button');
              locBtn.textContent = 'View Location';
              locBtn.style.marginLeft = '10px';
              locBtn.style.background = 'var(--primary)';
              locBtn.style.color = 'white';
              locBtn.style.border = 'none';
              locBtn.style.padding = '0.4rem 0.8rem';
              locBtn.style.borderRadius = 'var(--radius-sm)';
              locBtn.style.cursor = 'pointer';
              locBtn.style.fontWeight = '500';
              locBtn.onclick = () => {
                alert(`Location pinned at: Lat ${reply.mapPin.lat.toFixed(4)}, Lng ${reply.mapPin.lng.toFixed(4)}`);
              };
              replyEl.appendChild(locBtn);
            }

            repliesEl.appendChild(replyEl);
          });
        }

        enquiryEl.appendChild(repliesEl);

        // Reply form - only show if enquiry is not thanked
        if (!enquiry.thanked) {
          const replyForm = document.createElement('form');
          replyForm.className = 'reply-form';
          replyForm.setAttribute('aria-label', 'Reply to enquiry');

          const replyInput = document.createElement('input');
          replyInput.type = 'text';
          replyInput.placeholder = 'Write a reply...';
          replyInput.required = true;
          replyInput.setAttribute('aria-required', 'true');
          replyForm.appendChild(replyInput);

          const mapPinBtn = document.createElement('button');
          mapPinBtn.type = 'button';
          mapPinBtn.className = 'map-pin-btn';
          mapPinBtn.textContent = 'Add Map Pin';
          replyForm.appendChild(mapPinBtn);

          const mapContainer = document.createElement('div');
          mapContainer.className = 'map-container';
          enquiryEl.appendChild(mapContainer);

          let map, marker, mapPinCoords = null;

          mapPinBtn.onclick = () => {
            if (mapContainer.classList.contains('open')) {
              mapContainer.classList.remove('open');
              mapPinBtn.textContent = 'Add Map Pin';
              mapPinCoords = null;
              if (marker) {
                map.removeLayer(marker);
                marker = null;
              }
            } else {
              mapContainer.classList.add('open');
              mapPinBtn.textContent = 'Remove Map Pin';
              if (!map) {
                map = L.map(mapContainer).setView([9.05785, 7.49508], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                map.on('click', e => {
                  if (marker) {
                    marker.setLatLng(e.latlng);
                  } else {
                    marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                  }
                  mapPinCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
                });
              }
            }
          };

          const replyBtn = document.createElement('button');
          replyBtn.type = 'submit';
          replyBtn.textContent = 'Reply';
          replyForm.appendChild(replyBtn);

          replyForm.addEventListener('submit', async e => {
            e.preventDefault();
            const replyText = replyInput.value.trim();
            if (!replyText) return;
            await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                replyBy: userFullname,
                text: replyText,
                lat: mapPinCoords ? mapPinCoords.lat : '',
                lng: mapPinCoords ? mapPinCoords.lng : '',
                email: localStorage.getItem('email') || ''
              })
            });
            replyInput.value = '';
            if (mapContainer.classList.contains('open')) {
              mapContainer.classList.remove('open');
              mapPinBtn.textContent = 'Add Map Pin';
            }
            if (marker) {
              map.removeLayer(marker);
              marker = null;
            }
            mapPinCoords = null;
            await fetchEnquiries();
            replyInput.focus();
            if (!repliesEl.classList.contains('open')) {
              toggleReplies();
            }
          });

          enquiryEl.appendChild(replyForm);
        } else {
          const resolvedMessage = document.createElement('div');
          resolvedMessage.className = 'reply-form';
          resolvedMessage.innerHTML = '<p style="color: var(--text-muted); font-style: italic; text-align: center; padding: var(--spacing-sm);">This enquiry has been resolved - no further replies allowed</p>';
          enquiryEl.appendChild(resolvedMessage);
        }

        function toggleReplies() {
          const isOpen = repliesEl.classList.toggle('open');
          toggleIcon.classList.toggle('open', isOpen);
        }

        headerEl.onclick = toggleReplies;

        enquiryListEl.appendChild(enquiryEl);
      });
    }

    // Search functionality
    function searchEnquiries() {
      lastSearch = searchInput.value || '';
      renderEnquiries();
    }
    searchBtn.onclick = searchEnquiries;
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchEnquiries();
      }
    });

    // Post enquiry functionality
    postEnquiryBtn.onclick = async () => {
      const text = enquiryInputEl.value.trim();
      if (!text) {
        alert('Please enter your enquiry.');
        return;
      }
      
      const formData = new FormData();
      formData.append('fullname', userFullname);
      formData.append('email', localStorage.getItem('email') || '');
      formData.append('question', text);
      formData.append('enquiryType', selectedEnquiryType);
      
      if (newEnquiryImageFile) formData.append('image', newEnquiryImageFile);

      try {
        const res = await fetch('http://localhost:5000/enquiries', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) throw new Error('Failed to post enquiry');
        
        enquiryInputEl.value = '';
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        newEnquiryImageFile = null;
        imageUploadInput.value = '';
        fileUploadText.textContent = '+ Add or Drag Product Image';
        await fetchEnquiries();
        enquiryInputEl.focus();
      } catch {
        alert('Failed to post enquiry. Please try again.');
      }
    };
    
    // Initialize
    imagePreview.style.display = 'none';
    switchView('all');
    fetchDeals();
    fetchLeaderboard(); // Initialize leaderboard data

    // Enhanced Tour functionality
    const startTourBtn = document.getElementById('startTourBtn');
    startTourBtn.addEventListener('click', () => {
      introJs().setOptions({
        steps: [
          {
            intro: `
              <div style="text-align: center;">
                <h2 style="margin-bottom: 10px; color: var(--primary);">üèÜ Welcome to Customer's Connect!</h2>
                <p>Let's take a quick tour to explore all the amazing features we have for you.</p>
              </div>
            `
          },
          {
            element: document.querySelector('.view-toggle-container'),
            intro: `
              <div style="text-align: center;">
                <h3 style="margin-bottom: 8px;">üì± Navigation Menu</h3>
                <p>Use this dropdown to switch between different views:</p>
                <ul style="text-align: left; margin-top: 10px;">
                  <li><strong>All Enquiries:</strong> See what everyone is asking</li>
                  <li><strong>My Enquiries:</strong> Track your own questions</li>
                  <li><strong>Leaderboard:</strong> Check top contributors</li>
                  <li><strong>Deals:</strong> Discover amazing offers</li>
                </ul>
              </div>
            `,
            position: 'bottom'
          },
          {
            element: document.querySelector('.post-enquiry'),
            intro: `
              <div style="text-align: center;">
                <h3 style="margin-bottom: 8px;">üí¨ Post Enquiries</h3>
                <p>Ask questions about products, prices, availability, or get recommendations from our community.</p>
                <p><small>üí° <em>You can even add product images for better help!</em></small></p>
              </div>
            `,
            position: 'top'
          },
          {
            element: document.getElementById('dealsSidebar'),
            intro: `
              <div style="text-align: center;">
                <h3 style="margin-bottom: 8px;">üî• Hot Deals</h3>
                <p>Discover amazing deals shared by our community members.</p>
                <p><small>‚ú® <em>Share your own finds and help others save money!</em></small></p>
              </div>
            `,
            position: 'left'
          },
          {
            element: document.querySelector('.search-bar'),
            intro: `
              <div style="text-align: center;">
                <h3 style="margin-bottom: 8px;">üîç Smart Search</h3>
                <p>Quickly find specific enquiries or deals using our powerful search feature.</p>
                <p><small>üéØ <em>Search across both questions and replies!</em></small></p>
              </div>
            `,
            position: 'bottom'
          },
          {
            intro: `
              <div style="text-align: center;">
                <h3 style="margin-bottom: 10px; color: var(--success);">üéâ You're All Set!</h3>
                <p>You're now ready to explore Customer's Connect and connect with our amazing community.</p>
                <p style="margin-top: 15px;"><strong>Happy shopping and sharing! üõçÔ∏è</strong></p>
              </div>
            `
          }
        ],
        showStepNumbers: true,
        exitOnEsc: true,
        exitOnOverlayClick: false,
        nextLabel: 'Next ‚Üí',
        prevLabel: '‚Üê Back',
        skipLabel: 'Skip Tour',
        doneLabel: 'Finish',
        tooltipClass: 'custom-introjs-tooltip',
        highlightClass: 'custom-introjs-highlight'
      }).start();
    });

  </script>
</body>
</html>