<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer's Connect - Enquiries & Recommendations</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css" />
  <link rel = "stylesheet" href ="styles.css"/>
</head>
<body>
  <!-- THE CONTENT REMAINS THE SAME FROM HERE ‚Äî ALL IDs/CLASSES ARE COMPATIBLE -->
  <header>
    <div class="welcome">
      <svg class="dashboard-logo-inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M20.5 3l-5.5 2-5-2-6 2v16l6-2 5 2 5.5-2v-16zM12 17a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
      </svg>
      Welcome, <span id="userFullname">User</span>
    </div>
    <button class="dark-toggle" id="darkToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
    <a href = "profile.html" class = "profile-btn" id = "profileBtn" aria-label="My Profile" >My Profile</a>
    <button class="logout-btn" id="logoutBtn">Logout</button>
    <button class="tour-btn" id="startTourBtn" aria-label="Start guided tour">
      <span style="font-size:1.3em; vertical-align:middle;">&#128161;</span> Tour
    </button>
  </header>
  <nav class="view-toggle" aria-label="Toggle enquiry views"
    data-intro="Switch between all enquiries and just your own. Use this to filter what you see."
    data-title="Enquiry View Toggle"
    data-step="2">
    <button id="allEnquiriesBtn" class="active" aria-pressed="true">All Enquiries</button>
    <button id="myEnquiriesBtn" aria-pressed="false">My Enquiries</button>
  </nav>
  <div class="search-bar" role="search">
    <input type="search" id="searchInput" aria-label="Search enquiries" placeholder="Search enquiries..." />
    <button id="searchBtn" aria-label="Search enquiries">üîç</button>
  </div>
  <div id="loading" class="loading-message" style="display:none;">
    <span>‚è≥</span> Loading enquiries...
  </div>
  <div id="error" class="error-message" style="display:none;">
    <span>‚ö†Ô∏è</span> Could not load enquiries. <button id="retryBtn">Retry</button>
  </div>
  <main>
    <section class="post-enquiry" aria-label="Post a new enquiry"
      data-intro="Ask a question and optionally add a product image. Click 'Post Enquiry' to share."
      data-title="Post a New Enquiry"
      data-step="3">
      <textarea id="enquiryInput" placeholder="Ask where to find the best quality product..." aria-label="Enquiry text"></textarea>
      <div class="file-upload-area" id="fileUploadArea" tabindex="0" role="button" aria-describedby="fileUploadText">
        <span id="fileUploadText">+ Add or Drag Product Image</span>
        <input type="file" id="imageUpload" accept="image/*" style="display:none" />
      </div>
      <img id="imagePreview" class="image-preview" alt="Product preview" />
      <button id="postEnquiryBtn">Post Enquiry</button>
    </section>
    <section class="enquiry-list" id="enquiryList" aria-live="polite" aria-label="List of enquiries and replies"
      data-intro="Browse all posted enquiries and replies here. Click an enquiry to see more."
      data-title="Enquiries & Replies"
      data-step="4">
    </section>
  </main>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <!-- The rest of your JS remains identical -->
  <!-- ... JS code here ... -->
   <script>
    const socket = io('http://localhost:5000');
    socket.on('connect', () => {
      console.log('Socket.IO connected! Socket ID:', socket.id);
    });

    socket.on('newEnquiry', (enquiry) => {
      const index = enquiries.findIndex(e => e.id === enquiry.id);
      if (index >= 0) {
        enquiries[index] = enquiry;
      } else {
        enquiries.push(enquiry);
      }
      renderEnquiries();
    });
    socket.on('newReply', ({ enquiryId, reply }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        enquiry.replies = enquiry.replies || [];
        enquiry.replies.push(reply);
        renderEnquiries();
      }
    });
    socket.on('replyLiked', ({ enquiryId, replyId, likes, likedBy }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        const reply = enquiry.replies.find(r => r.replyId === replyId);
        if (reply) {
          reply.likes = likes;
          reply.likedBy = likedBy;
          renderEnquiries();
        }
      }
    });
    socket.on('replyDisliked', ({ enquiryId, replyId, dislikes, dislikedBy }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        const reply = enquiry.replies.find(r => r.replyId === replyId);
        if (reply) {
          reply.dislikes = dislikes;
          reply.dislikedBy = dislikedBy;
          renderEnquiries();
        }
      }
    });
    socket.on('enquiryDeleted', ({ enquiryId }) => {
      enquiries = enquiries.filter(e => e.id !== enquiryId);
      renderEnquiries();
    });
    socket.on('enquiryThanked', ({ enquiryId, thanked }) => {
      const enquiry = enquiries.find(e => e.id === enquiryId);
      if (enquiry) {
        enquiry.thanked = thanked;
        renderEnquiries();
      }
    });

    const darkToggle = document.getElementById('darkToggle');
    darkToggle.onclick = () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
      darkToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    const userFullname = localStorage.getItem('fullname') || 'User';
    document.getElementById('userFullname').textContent = userFullname;
    const logoutBtn = document.getElementById('logoutBtn');
    const allEnquiriesBtn = document.getElementById('allEnquiriesBtn');
    const myEnquiriesBtn = document.getElementById('myEnquiriesBtn');
    const enquiryListEl = document.getElementById('enquiryList');
    const enquiryInputEl = document.getElementById('enquiryInput');
    const postEnquiryBtn = document.getElementById('postEnquiryBtn');
    const imageUploadInput = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileUploadText = document.getElementById('fileUploadText');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const retryBtn = document.getElementById('retryBtn');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');

    // Store current reported enquiries for session
    const reportedEnquiries = new Set();

    let enquiries = [];
    let currentView = 'all';
    let newEnquiryImageFile = null;
    let lastSearch = '';

    logoutBtn.onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('fullname');
      alert('Logged out');
      window.location.href = 'index.html';
    };

    allEnquiriesBtn.onclick = () => {
      if (currentView !== 'all') {
        currentView = 'all';
        updateViewToggle();
        fetchEnquiries();
      }
    };
    myEnquiriesBtn.onclick = () => {
      if (currentView !== 'mine') {
        currentView = 'mine';
        updateViewToggle();
        fetchEnquiries();
      }
    };

    function updateViewToggle() {
      if (currentView === 'all') {
        allEnquiriesBtn.classList.add('active');
        allEnquiriesBtn.setAttribute('aria-pressed', 'true');
        myEnquiriesBtn.classList.remove('active');
        myEnquiriesBtn.setAttribute('aria-pressed', 'false');
      } else {
        myEnquiriesBtn.classList.add('active');
        myEnquiriesBtn.setAttribute('aria-pressed', 'true');
        allEnquiriesBtn.classList.remove('active');
        allEnquiriesBtn.setAttribute('aria-pressed', 'false');
      }
    }

    fileUploadArea.addEventListener('click', () => imageUploadInput.click());
    fileUploadArea.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        imageUploadInput.click();
      }
    });
    fileUploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });
    fileUploadArea.addEventListener('dragleave', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
    });
    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        imageUploadInput.files = e.dataTransfer.files;
        imageUploadInput.dispatchEvent(new Event('change'));
      }
    });

    imageUploadInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) {
        newEnquiryImageFile = null;
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        fileUploadText.textContent = '+ Add or Drag Product Image';
        return;
      }
      newEnquiryImageFile = file;
      const reader = new FileReader();
      reader.onload = function(event) {
        imagePreview.src = event.target.result;
        imagePreview.style.display = 'block';
        fileUploadText.textContent = 'Image selected!';
      };
      reader.readAsDataURL(file);
    });

    async function fetchEnquiries() {
      loadingEl.style.display = 'flex';
      errorEl.style.display = 'none';
      enquiryListEl.innerHTML = '';
      try {
        const res = await fetch('http://localhost:5000/enquiries');
        if (!res.ok) throw new Error('Failed to fetch enquiries');
        enquiries = await res.json();
        loadingEl.style.display = 'none';
        renderEnquiries();
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'flex';
      }
    }

    retryBtn.onclick = fetchEnquiries;

    // Report Enquiry handler
    async function handleReportClick(enquiryId, button, dropdown) {
      if (reportedEnquiries.has(enquiryId)) {
        alert('You have already reported this enquiry.');
        return;
      }
      const confirmReport = confirm('Are you sure you want to report this enquiry?');
      if (!confirmReport) return;

      try {
        const res = await fetch(`http://localhost:5000/enquiries/${enquiryId}/report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: userFullname })
        });
        if (!res.ok) {
          const err = await res.json();
          alert('Failed to report enquiry: ' + (err.error || 'Unknown error'));
          return;
        }
        reportedEnquiries.add(enquiryId);
        alert('Enquiry reported. Thank you.');
        button.disabled = true;
        dropdown.classList.remove('open');
      } catch (error) {
        alert('Error reporting enquiry. Please try again.');
      }
    }

    function renderEnquiries() {
      enquiryListEl.innerHTML = '';
      let filteredEnquiries = enquiries;
      if (currentView === 'mine') {
        filteredEnquiries = enquiries.filter(e => e.postedBy === userFullname);
      }
      if (lastSearch.trim()) {
        const q = lastSearch.trim().toLowerCase();
        filteredEnquiries = filteredEnquiries.filter(
          e => (e.question && e.question.toLowerCase().includes(q)) ||
            (e.replies && e.replies.some(r => r.text && r.text.toLowerCase().includes(q)))
        );
      }
      if (!filteredEnquiries || filteredEnquiries.length === 0) {
        enquiryListEl.innerHTML = `<p style="color:var(--muted); font-style: italic;">No enquiries to display.</p>`;
        return;
      }
      filteredEnquiries.slice().reverse().forEach((enquiry) => {
        const enquiryEl = document.createElement('article');
        enquiryEl.className = 'enquiry-item';
        enquiryEl.setAttribute('tabindex', '0');
        if (enquiry.thanked) {
          enquiryEl.classList.add('thanked');
        } else {
          enquiryEl.classList.remove('thanked');
        }

        // Header with toggle + three dots button
        const headerEl = document.createElement('div');
        headerEl.className = 'enquiry-header';

        // Question text span
        const questionSpan = document.createElement('span');
        questionSpan.textContent = enquiry.question;
        headerEl.appendChild(questionSpan);

        // Poster label
        const userLabel = document.createElement('span');
        userLabel.className = 'poster';
        userLabel.innerHTML = `(posted by <span class="posted-user">${enquiry.postedBy}</span>)`;
        headerEl.appendChild(userLabel);

        // Toggle icon
        const toggleIcon = document.createElement('span');
        toggleIcon.className = 'toggle-icon';
        toggleIcon.innerHTML = '&#9660;';
        headerEl.appendChild(toggleIcon);

        // Three dots menu for non-posters
        if (enquiry.postedBy !== userFullname) {
          const threeDotsBtn = document.createElement('button');
          threeDotsBtn.className = 'three-dots-btn';
          threeDotsBtn.setAttribute('aria-label', 'More options');
          threeDotsBtn.innerHTML = '&#8942;';

          const dropdownMenu = document.createElement('div');
          dropdownMenu.className = 'dropdown-menu';

          const reportBtn = document.createElement('button');
          reportBtn.textContent = reportedEnquiries.has(enquiry.id) ? 'Reported' : 'Report Enquiry';
          reportBtn.disabled = reportedEnquiries.has(enquiry.id);
          reportBtn.onclick = e => {
            e.stopPropagation();
            handleReportClick(enquiry.id, reportBtn, dropdownMenu);
          };
          dropdownMenu.appendChild(reportBtn);

          threeDotsBtn.onclick = e => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
              if (menu !== dropdownMenu) menu.classList.remove('open');
            });
            dropdownMenu.classList.toggle('open');
          };

          document.addEventListener('click', () => {
            dropdownMenu.classList.remove('open');
          });

          headerEl.appendChild(threeDotsBtn);
          headerEl.appendChild(dropdownMenu);
        }

        // Original delete and thanks buttons for poster
        if (enquiry.postedBy === userFullname) {
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.style.background = '#ef4444';
          deleteBtn.style.color = 'white';
          deleteBtn.style.border = 'none';
          deleteBtn.style.padding = '6px 12px';
          deleteBtn.style.borderRadius = '8px';
          deleteBtn.style.cursor = 'pointer';
          deleteBtn.style.fontWeight = '700';
          deleteBtn.style.marginLeft = '10px';

          deleteBtn.onclick = async e => {
            e.stopPropagation();
            if (!confirm('Are you sure you want to delete this enquiry?')) return;
            try {
              const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}?user=${encodeURIComponent(userFullname)}`, {
                method: 'DELETE'
              });
              if (!res.ok) {
                const err = await res.json();
                alert('Failed to delete enquiry: ' + (err.error || 'Unknown error'));
                return;
              }
              enquiries = enquiries.filter(e => e.id !== enquiry.id);
              renderEnquiries();
            } catch {
              alert('Error deleting enquiry. Please try again.');
            }
          };
          headerEl.appendChild(deleteBtn);

          const thanksBtn = document.createElement('button');
          thanksBtn.className = 'thanks-btn';
          thanksBtn.title = 'Mark enquiry as met and say thanks';
          thanksBtn.textContent = enquiry.thanked ? 'Thanked ‚úÖ' : 'Thanks ‚úÖ';

          thanksBtn.onclick = async ev => {
            ev.stopPropagation();
            try {
              const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/thanks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: userFullname }),
              });
              if (!res.ok) {
                const err = await res.json();
                alert('Failed to update thanks: ' + (err.error || 'Unknown error'));
                return;
              }
              enquiry.thanked = !enquiry.thanked;
              thanksBtn.textContent = enquiry.thanked ? 'Thanked ‚úÖ' : 'Thanks ‚úÖ';
              enquiryEl.classList.toggle('thanked', enquiry.thanked);
            } catch {
              alert('Error marking thanks. Please try again.');
            }
          };
          headerEl.appendChild(thanksBtn);
        }

        enquiryEl.appendChild(headerEl);

        // Image if any
        if (enquiry.image && typeof enquiry.image === 'string' && enquiry.image.trim() !== '') {
          const imgEl = document.createElement('img');
          imgEl.className = 'enquiry-image';
          imgEl.src = `http://localhost:5000${enquiry.image}`;
          imgEl.alt = 'Product image for enquiry';
          enquiryEl.appendChild(imgEl);
        }

        // Replies container
        const repliesEl = document.createElement('div');
        repliesEl.className = 'reply-list';

        if (Array.isArray(enquiry.replies)) {
          // Sort replies by like/dislike ratio desc, tie break by likes desc
          enquiry.replies.sort((a, b) => {
            function ratio(r) {
              if ((r.dislikes || 0) === 0) return r.likes > 0 ? Infinity : 0;
              return r.likes / r.dislikes;
            }
            const ra = ratio(a);
            const rb = ratio(b);
            if (rb === ra) return (b.likes || 0) - (a.likes || 0);
            return rb - ra;
          });

          enquiry.replies.forEach(reply => {
            const replyEl = document.createElement('div');
            replyEl.className = 'reply-item';

            const replyTextEl = document.createElement('div');
            replyTextEl.className = 'reply-text';
            replyTextEl.textContent = `${reply.replyBy}: ${reply.text}`;
            replyEl.appendChild(replyTextEl);

            // Like button
            const likeBtn = document.createElement('button');
            likeBtn.className = 'like-btn';
            likeBtn.setAttribute('aria-label', 'Like reply');
            likeBtn.innerHTML = `&#10084; <span>${reply.likes || 0}</span>`;
            if (reply.likedBy && reply.likedBy.includes(userFullname)) {
              likeBtn.classList.add('liked');
            }
            likeBtn.onclick = async () => {
              try {
                const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies/${reply.replyId}/like`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user: userFullname })
                });
                const result = await res.json();
                if (result && result.liked !== undefined) {
                  await fetchEnquiries();
                }
              } catch {
                alert('Failed to update like. Try again.');
              }
            };
            replyEl.appendChild(likeBtn);

            // Dislike button (shown with count only to enquiry poster)
            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = 'dislike-btn';
            dislikeBtn.setAttribute('aria-label', 'Dislike reply');
            dislikeBtn.innerHTML = `&#128078; <span></span>`;
            if (enquiry.postedBy === userFullname) {
              dislikeBtn.querySelector('span').textContent = reply.dislikes || 0;
            } else {
              dislikeBtn.querySelector('span').textContent = '';
            }
            if (reply.dislikedBy && reply.dislikedBy.includes(userFullname)) {
              dislikeBtn.classList.add('disliked');
            }
            dislikeBtn.onclick = async () => {
              try {
                const res = await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies/${reply.replyId}/dislike`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user: userFullname })
                });
                const result = await res.json();
                if (result && typeof result.disliked !== 'undefined') {
                  await fetchEnquiries();
                }
              } catch {
                alert('Failed to update dislike. Try again.');
              }
            };
            replyEl.appendChild(dislikeBtn);

            // View location button if mapPin present
            if (reply.mapPin) {
              const locBtn = document.createElement('button');
              locBtn.textContent = 'View Location';
              locBtn.style.marginLeft = '10px';
              locBtn.style.background = 'var(--primary)';
              locBtn.style.color = 'white';
              locBtn.style.border = 'none';
              locBtn.style.padding = '4px 8px';
              locBtn.style.borderRadius = '8px';
              locBtn.style.cursor = 'pointer';
              locBtn.onclick = () => {
                alert(`Location pinned at: Lat ${reply.mapPin.lat.toFixed(4)}, Lng ${reply.mapPin.lng.toFixed(4)}`);
              };
              replyEl.appendChild(locBtn);
            }

            repliesEl.appendChild(replyEl);
          });
        }

        enquiryEl.appendChild(repliesEl);

        // Reply form
        const replyForm = document.createElement('form');
        replyForm.className = 'reply-form';
        replyForm.setAttribute('aria-label', 'Reply to enquiry');

        const replyInput = document.createElement('input');
        replyInput.type = 'text';
        replyInput.placeholder = 'Write a reply...';
        replyInput.required = true;
        replyInput.setAttribute('aria-required', 'true');
        replyForm.appendChild(replyInput);

        const mapPinBtn = document.createElement('button');
        mapPinBtn.type = 'button';
        mapPinBtn.className = 'map-pin-btn';
        mapPinBtn.textContent = 'Add Map Pin';
        replyForm.appendChild(mapPinBtn);

        const mapContainer = document.createElement('div');
        mapContainer.className = 'map-container';
        enquiryEl.appendChild(mapContainer);

        let map, marker, mapPinCoords = null;

        mapPinBtn.onclick = () => {
          if (mapContainer.classList.contains('open')) {
            mapContainer.classList.remove('open');
            mapPinBtn.textContent = 'Add Map Pin';
            mapPinCoords = null;
            if (marker) {
              map.removeLayer(marker);
              marker = null;
            }
          } else {
            mapContainer.classList.add('open');
            mapPinBtn.textContent = 'Remove Map Pin';
            if (!map) {
              map = L.map(mapContainer).setView([9.05785, 7.49508], 13);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
              }).addTo(map);
              map.on('click', e => {
                if (marker) {
                  marker.setLatLng(e.latlng);
                } else {
                  marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                }
                mapPinCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
              });
            }
          }
        };

        const replyBtn = document.createElement('button');
        replyBtn.type = 'submit';
        replyBtn.textContent = 'Reply';
        replyForm.appendChild(replyBtn);

        replyForm.addEventListener('submit', async e => {
          e.preventDefault();
          const replyText = replyInput.value.trim();
          if (!replyText) return;
          await fetch(`http://localhost:5000/enquiries/${enquiry.id}/replies`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              replyBy: userFullname,
              text: replyText,
              lat: mapPinCoords ? mapPinCoords.lat : '',
              lng: mapPinCoords ? mapPinCoords.lng : ''
            })
          });
          replyInput.value = '';
          if (mapContainer.classList.contains('open')) {
            mapContainer.classList.remove('open');
            mapPinBtn.textContent = 'Add Map Pin';
          }
          if (marker) {
            map.removeLayer(marker);
            marker = null;
          }
          mapPinCoords = null;
          await fetchEnquiries();
          replyInput.focus();
          if (!repliesEl.classList.contains('open')) {
            toggleReplies();
          }
        });

        enquiryEl.appendChild(replyForm);

        function toggleReplies() {
          const isOpen = repliesEl.classList.toggle('open');
          toggleIcon.classList.toggle('open', isOpen);
        }

        headerEl.onclick = toggleReplies;

        enquiryListEl.appendChild(enquiryEl);
      });
    }

    function searchEnquiries() {
      lastSearch = searchInput.value || '';
      renderEnquiries();
    }
    searchBtn.onclick = searchEnquiries;
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchEnquiries();
      }
    });

    postEnquiryBtn.onclick = async () => {
      const text = enquiryInputEl.value.trim();
      if (!text) {
        alert('Please enter your enquiry.');
        return;
      }
      const formData = new FormData();
      formData.append('fullname', userFullname);
      formData.append('email', '');
      formData.append('question', text);
      if (newEnquiryImageFile) formData.append('image', newEnquiryImageFile);

      try {
        const res = await fetch('http://localhost:5000/enquiries', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) throw new Error('Failed to post enquiry');
        enquiryInputEl.value = '';
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        newEnquiryImageFile = null;
        imageUploadInput.value = '';
        fileUploadText.textContent = '+ Add or Drag Product Image';
        await fetchEnquiries();
        enquiryInputEl.focus();
      } catch {
        alert('Failed to post enquiry. Please try again.');
      }
    };

    imagePreview.style.display = 'none';
    updateViewToggle();
    fetchEnquiries();
    const startTourBtn = document.getElementById('startTourBtn');
    startTourBtn.addEventListener('click', () => {
      introJs()
        .setOptions({
          steps: [
            {
              intro: "Welcome to Customer's Connect! Let's take a quick tour."
            },
            {
              element: document.querySelector('.view-toggle'),
              intro: "Switch between viewing all enquiries or just your own here.",
              position: 'bottom'
            },
            {
              element: document.querySelector('.post-enquiry'),
              intro: "Use this section to post a new enquiry. You can add a product image!",
              position: 'top'
            },
            {
              element: document.querySelector('.enquiry-list'),
              intro: "Browse all enquiries and their replies here. Click on enquiries to expand.",
              position: 'top'
            },
            {
              element: document.getElementById('darkToggle'),
              intro: "Toggle between light and dark modes here for your preferred look.",
              position: 'left'
            },
            {
              element: document.getElementById('logoutBtn'),
              intro: "When you're done, click logout to end your session safely.",
              position: 'left'
            }
          ],
          showStepNumbers: true,
          exitOnEsc: true,
          exitOnOverlayClick: false,
          nextLabel: 'Next >',
          prevLabel: '< Prev',
          skipLabel: 'Skip',
          doneLabel: 'Finish'
        })
        .start();
    });
  </script>
</body>
</html>  
  